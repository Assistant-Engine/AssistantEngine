@page "/modelscopy"
@using AssistantEngine.Factories
@using AssistantEngine.UI.Pages.Chat
@using AssistantEngine.UI.Services
@inject ChatClientState ClientState
@using AssistantEngine.UI.Services.Implementation.Ollama
@using AssistantEngine.UI.Services.Models
@using OllamaSharp
@using OllamaSharp.Models
@using System.Text.RegularExpressions
@inject OllamaImportService ModelService
@inject IAppHealthService Health
@inject IModelInstaller Installer
@inject IModelCache ModelCache
@if (loading)
{
    <PageSpinner1></PageSpinner1>
}
else
{
    <div id="ollama-install-page" class="ollama-page">
        <div class="ollama-import-header nav-top">
            <h4 class="ollama-import-title">
                Download Models

                <div class="server-config-wrapper">
                    <div class="server-config-text">
                        Assistant Server:
                    </div>
                    <ConfigDropdown @ref="configDD" OnSelect="@HandleModelAssistantSelected" />
                </div>
            </h4>
        </div>

        <div class="ollama-split">
            <aside class="ollama-left">
                <div class="search-box">
                    <i class="fi fi-br-search"></i>
                    <input class="form-control ollama-install-search" placeholder="Search models…" @bind="search" @bind:event="oninput" />
                </div>

                @if (!string.IsNullOrWhiteSpace(_loadError))
                {
                <div class="error">@_loadError</div>
                }
                else if (models is null || models.Count == 0)
                {
                <p>No models available.</p>
                }
                else
                {

                    @if (!FilteredModels.ToList().Any())
                    {
                        <div class="empty-note">
                            No models match your search.
                        </div>
                    }
                    else
                    {
                        <ul class="model-list-nav">
                            @foreach (var m in FilteredModels)
                            {
                                var selected = ReferenceEquals(SelectedModel, m) ? "selected" : "";
                                <li class="model-list-item @selected" @onclick="@(() => SelectModel(m))" title="@m.Description">
                                    <div class="model-name-row">
                                        <span class="model-name">@m.Name</span>
                                        @if (IsInstalled(m))
                                        {
                                            <span class="badge installed">Installed</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(m.Description))
                                    {
                                        <div class="model-desc-trunc">@m.Description</div>
                                    }
                                </li>
                            }
                        </ul>
                    }
       
                }
            </aside>

            <!-- RIGHT: selected model details -->
            <section class="ollama-right">
                @if (SelectedModel is null)
                {
                    <div class="placeholder">
                        <h5>Select a model from the left</h5>
                        <p>Use the search to quickly find a model, then click to view versions and details here.</p>
                    </div>
                }
                else
                {
                    <div class="model-details">
                        <header class="model-details-header">
                            <h3 class="model-details-title">@SelectedModel.Name</h3>
                            @if (IsInstalled(SelectedModel))
                            {
                                <span class="badge installed">Installed</span>
                            }
                            @if (IsRunning(SelectedModel))
                            {
                                <span class="badge running">Running</span>
                            }
                        </header>

                        @if (!string.IsNullOrWhiteSpace(SelectedModel.Description))
                        {
                            <p class="model-details-desc">@SelectedModel.Description</p>
                        }

                        <div class="model-versions">
                            <h5 class="version-text">Versions</h5>
                            @if (SelectedModel.Dropdowns?.Any() == true)
                            {
                                <ul class="version-list">
                                    @foreach (var d in SelectedModel.Dropdowns)
                                    {
                                        <li class="version-item">
                                            @((MarkupString)d)
                                            @if (VersionInstalled(d, SelectedModel))
                                            {
                                                <button class="btn download-btn ollama-download disabled">Installed</button>
                                            }
                                            else
                                            {
                                                <button class="btn download-btn ollama-download"><i class="fi-br-download"></i>Download</button>
                                            }

                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p>No versions listed.</p>
                            }
                        </div>


                    </div>
                }
            </section>
        </div>
    </div>
}

@code {
    private List<OllamaImportModel>? models;
    private OllamaImportModel? SelectedModel;
    private List<Model> local_models = new();
    private List<RunningModel> running_models = new();
    private bool loading;
    private string? _loadError;
    private string search = "";
    private ConfigDropdown @configDD;
    private readonly CancellationTokenSource cts = new();
    private DotNetObjectReference<OllamaInstall>? _selfRef;


    protected override async Task OnInitializedAsync()
    {
        loading = true;
        models = await ModelService.GetModelsAsync();
        if (models?.Count > 0) SelectedModel = models[0];

        ModelCache.Changed += OnCacheChanged;
        await ModelCache.EnsureStartedAsync();
        Snapshot();
        loading = false;
    }

    private void OnCacheChanged()
    {
        Snapshot();
        InvokeAsync(StateHasChanged);
    }

    private void Snapshot()
    {
        local_models = ModelCache.LocalModels.ToList();
        running_models = ModelCache.RunningModels.ToList();

        if (SelectedModel is not null && !(models?.Any(x => x.Name == SelectedModel.Name) ?? false))
            SelectedModel = null;
    }

    private IEnumerable<OllamaImportModel> FilteredModels =>
        string.IsNullOrWhiteSpace(search)
            ? (models ?? Enumerable.Empty<OllamaImportModel>())
            : (models ?? Enumerable.Empty<OllamaImportModel>())
                .Where(m =>
                    (m.Name?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (m.Description?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false));

    private static readonly Regex ModelTagRx =
        new(@"([\w\-.]+:[\w\-.]+)", RegexOptions.IgnoreCase | RegexOptions.Compiled);

    private bool VersionInstalled(string markup, OllamaImportModel? selected)
    {
        if (selected is null) return false;
        var localNames = MatchingLocal(selected).Select(l => l.Name).ToList();
        if (localNames.Count == 0) return false;

        if (localNames.Any(n => string.Equals(n, markup, StringComparison.OrdinalIgnoreCase))) return true;

        var m = ModelTagRx.Match(markup);
        if (m.Success)
        {
            var token = m.Groups[1].Value;
            return localNames.Any(n => string.Equals(n, token, StringComparison.OrdinalIgnoreCase));
        }
        return false;
    }

    private IEnumerable<Model> MatchingLocal(OllamaImportModel m)
    {
        if (local_models is null || m is null) yield break;
        var baseName = (m.Name ?? "").Trim();
        if (string.IsNullOrWhiteSpace(baseName)) yield break;
        foreach (var lm in local_models)
            if (lm.Name.StartsWith(baseName, StringComparison.OrdinalIgnoreCase))
                yield return lm;
    }
    private async Task HandleModelAssistantSelected(AssistantConfig model)
    {
        await ModelCache.RefreshNowAsync();
    }
    private bool IsInstalled(OllamaImportModel m) => MatchingLocal(m).Any();

    private bool IsRunning(OllamaImportModel m)
    {
        var baseName = (m.Name ?? "").Trim();
        if (string.IsNullOrWhiteSpace(baseName)) return false;
        return running_models?.Any(r => r.Name?.StartsWith(baseName, StringComparison.OrdinalIgnoreCase) == true) == true;
    }

    private void SelectModel(OllamaImportModel m)
    {
        SelectedModel = m;
        StateHasChanged();
    }

    private string FormatBytes(long bytes)
    {
        if (bytes >= 1_000_000_000) return $"{bytes / 1_000_000_000.0:F2} GB";
        if (bytes >= 1_000_000) return $"{bytes / 1_000_000.0:F2} MB";
        if (bytes >= 1_000) return $"{bytes / 1_000.0:F2} KB";
        return $"{bytes} B";
    }


    [JSInvokable]
    public Task PullModelFromLink(string model)
    {
        _ = Task.Run(() => Installer.PullAsync(model, cts.Token));
        return Task.CompletedTask;
    }
    public void Dispose() => _selfRef?.Dispose();

}
