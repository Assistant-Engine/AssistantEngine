@page "/models"
@using AssistantEngine.Factories
@using AssistantEngine.UI.Pages.Chat
@using AssistantEngine.UI.Services
@inject ChatClientState ClientState;
@using AssistantEngine.UI.Services.Implementation.Ollama
@using AssistantEngine.UI.Services.Models
@using OllamaSharp
@using OllamaSharp.Models
@inject OllamaImportService ModelService
@inject IAppHealthService Health
@inject IModelCache ModelCache
@inject IJSRuntime JSRuntime

<div id="ollama-import-page" class="">
    <div class="ollama-import-header nav-top">
        <h4 class="ollama-import-title">Installed Models     
            <div class="server-config-wrapper">
                <div class="server-config-text">
                    Assistant Server:
                </div>
                <ConfigDropdown @ref="configDD" OnSelect="@HandleModelAssistantSelected" />
                </div>
         </h4>
      
    </div>
    <div class="inner-row">
        <div class="ollama-local-content">
  
            <div class="ollama-inner-1">
                @if (local_models == null || loading)
                    {
                    <PageSpinner1></PageSpinner1>
                }
                else
                {
                    <div class="table-wrap">
                        <table class="models-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Quant</th>
                                    <th>Arch</th>
                                    <th>Parameters</th>
                                    <th>Modified</th>
                                    <th>Size</th>
                                    <th class="more-col"></th>
                                </tr>
                            </thead>

                            <tbody>
                                @{
                                    var loadedSet = new HashSet<string>(running_models.Select(r => r.Name));
                                }

                                @foreach (var m in local_models
                                                            .OrderBy(m => !loadedSet.Contains(m.Name))
                                                            .ThenBy(m => m.Name, StringComparer.OrdinalIgnoreCase))
                                {
                                    
                                        bool loaded = loadedSet.Contains(m.Name);
                             
                                    <tr @key="m.Name" class="local-model-row @(loaded ? "running" : null)" title="@m.Digest">
                                        <td class="model-name">
                                            <div class="model-name-div">@m.Name</div>
                                            @if (loaded)
                                            {
                                                <span class="badge-running">● Loaded</span>
                                            }
                                        </td>
                                        <td class="model-quant-level"><div class="model-quant-level-div">@NA(m.Details?.QuantizationLevel)</div></td>
                                        <td class="model-familiy"><div class="model-familiy-div">@FamilyOf(m.Details?.Family, m.Details?.Families)</div></td>
                                        <td class="model-param-size"><div class="model-param-size-div">@NA(m.Details?.ParameterSize)</div></td>
                                        <td class="model-modified-time"><div class="model-modified-time-div">@m.ModifiedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</div></td>
                                        <td class="model-size"><div class="model-size-div">@FormatBytes(m.Size)</div></td>

                                        <td class="more-col">
                                            <div class="more-wrap">
                                                <button type="button" class="btn btn-default icon-btn more-btn"
                                                        @onclick="() => ToggleMore(m)" title="More">
                                                    <i class="fi fi-br-menu-dots"></i>
                                                </button>

                                                @if (IsMenuOpen(m))
                                                {
                                                    <div class="more-menu shadow-2">
                                                        @if (!loaded)
                                                        {
                                                            <button type="button" class="more-item"
                                                                    disabled="@(IsBusy(m))"
                                                                    @onclick="() => LoadModel(m, -1)">
                                                                <i class="fi fi-br-cpu me-1"></i><span>Load to GPU</span>
                                                            </button>
                                                        }
                                                        else
                                                        {


                                                            <button type="button" class="more-item danger"
                                                                    disabled="@(IsBusy(m))"
                                                                    @onclick="() => UnloadModel(m)">
                                                                <i class="fi fi-br-power me-1"></i><span>Unload from GPU</span>
                                                            </button>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

            </div>

        </div>
    </div>
</div>
@code {
    private List<OllamaImportModel>? models;
    private string? _loadError;
    private readonly HashSet<string> _busy = new();
    private readonly Dictionary<string, bool> _rowMenu = new();

    private List<Model> local_models = new();
    private List<RunningModel> running_models = new();
    private bool loading;

    IOllamaApiClient Client => ClientState.OllamaClient;

    protected override async Task OnInitializedAsync()
    {
        ModelCache.Changed += OnCacheChanged;
        await ModelCache.EnsureStartedAsync();
        models = await ModelService.GetModelsAsync();
        Snapshot();
    }

    private void OnCacheChanged()
    {
        Snapshot();
        InvokeAsync(StateHasChanged);
    }

    private void Snapshot()
    {
        loading = false;
        local_models = ModelCache.LocalModels.ToList();
        running_models = ModelCache.RunningModels.ToList();
    }

    private string KeyOf(Model m) => m.Name;
    private string KeyOf(string name, string? digest) => name;
    private string KeyOf(RunningModel r) => r.Name;

    private bool IsMenuOpen(Model m) => _rowMenu.TryGetValue(KeyOf(m), out var v) && v;
    private bool IsBusy(Model m) => _busy.Contains(KeyOf(m));
    private void ToggleMore(Model m) => _rowMenu[KeyOf(m)] = !_rowMenu.GetValueOrDefault(KeyOf(m));

    private async Task LoadModel(Model m, int seconds = -1)
    {
        if(seconds == 0)
        {
            await JSRuntime.InvokeVoidAsync("GLOBAL.toastrInterop.success", $"Unloading {m.Name} from GPU", "Unloading");
            //ClientState.StatusMessage($"Unloading model {m.Name} from GPU");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("GLOBAL.toastrInterop.success", $"Loading {m.Name} into GPU" , "Loading");
            //ClientState.StatusMessage($"Loading Model {m.Name} into GPU");
        }
        //   
        var key = KeyOf(m);
        if (!_busy.Add(key)) return;

        _rowMenu[key] = false;
        StateHasChanged();
        try
        {
            var keepAlive = seconds < 0 ? "-1m" : $"{seconds}";
            var req = new GenerateRequest { KeepAlive = keepAlive, Model = m.Name, Prompt = " ", Stream = false };
            await foreach (var _ in Client.GenerateAsync(req)) { break; }
   
            await ModelCache.RefreshNowAsync();
        }
        finally { _busy.Remove(key); }
    }

    private Task UnloadModel(Model m) => LoadModel(m, 0);

    private ConfigDropdown configDD;
    private static string NA(string? v) => string.IsNullOrWhiteSpace(v) ? "—" : v;
    private static string FamilyOf(string? family, string[]? families)
        => !string.IsNullOrWhiteSpace(family) ? family
           : (families is { Length: > 0 } ? string.Join(", ", families) : "—");

    private string FormatBytes(long bytes)
    {
        if (bytes >= 1_000_000_000) return $"{bytes / 1_000_000_000.0:F2} GB";
        if (bytes >= 1_000_000) return $"{bytes / 1_000_000.0:F2} MB";
        if (bytes >= 1_000) return $"{bytes / 1_000.0:F2} KB";
        return $"{bytes} B";
    }

    private async Task HandleModelAssistantSelected(AssistantConfig model)
    {
        await ModelCache.RefreshNowAsync();
    }
}
