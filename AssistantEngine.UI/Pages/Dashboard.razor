@page "/"
@using AssistantEngine.Factories
@using AssistantEngine.UI.Services
@using AssistantEngine.UI.Services.Types
@using System.ComponentModel
@inject IJSRuntime JSRuntime
@inject IAppHealthService Health
@inject ChatClientState State
@inject IModelCache ModelCache


<PageTitle>Assistant Engine - Chat</PageTitle>

<LeftSidebar ActiveTab="@current" OnTabChanged="tab => current = tab" />

<div class="content">
    @switch (current)
    {
        case SidebarTab.Chats:
            <AssistantEngine.UI.Pages.Chat.Chat />
            break;
        case SidebarTab.Evaluations:
            <AssistantEngine.UI.Pages.EvaluationsPanel />
            break;
        case SidebarTab.Models:
            <AssistantEngine.UI.Pages.InstalledModels />
            break;
        case SidebarTab.Install:
            <AssistantEngine.UI.Pages.OllamaInstall />
            break;
        case SidebarTab.Settings:
            <AssistantEngine.UI.Pages.GlobalSettings />
            break;
    }
    <ModalPopup />
</div>

@code {
    private AppHealthSnapshot _health;
    private EventHandler<AppHealthSnapshot>? _healthHandler;
    private SidebarTab current = SidebarTab.Chats;
    private DotNetObjectReference<Dashboard>? _ref;
    private readonly CancellationTokenSource cts = new();

    // 1) Init _health before first use
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        State.OnStatusMessage -= HandleStatus;
        State.OnStatusMessage += HandleStatus;

        _health = Health.Snapshot;                 // <-- add this
        ShowOllamaHealthToast(_health);            // now safe

        _healthHandler = OnHealthChanged;
        Health.Changed += _healthHandler;

        _ref ??= DotNetObjectReference.Create(this);
        await JSRuntime.InvokeVoidAsync("GLOBAL.SetOllamaRef", _ref);
        await ModelCache.EnsureStartedAsync();
    }


    protected override async Task OnInitializedAsync()
    {
        await State.ChangeModelAsync();
        await InvokeAsync(StateHasChanged);
        await base.OnInitializedAsync();
    }

    private void HandleStatus(StatusMessage s)
    {
        _ = ShowToastAsync(s); // fire-and-forget
    }

    private void OnHealthChanged(object? sender, AppHealthSnapshot snap)
    {
        _health = snap;
        ShowOllamaHealthToast(snap);
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task ShowToastAsync(StatusMessage s)
    {
        try
        {
            var method = s.Level switch
            {
                StatusLevel.Success => "success",
                StatusLevel.Warning => "warning",
                StatusLevel.Error => "error",
                _ => "info"
            };
            var title = string.IsNullOrWhiteSpace(s.Title)
                ? s.Level switch
                {
                    StatusLevel.Success => "Success",
                    StatusLevel.Warning => "Warning",
                    StatusLevel.Error => "Error",
                    _ => "Info"
                }
                : s.Title;

       
            if (s.Message.StartsWith("TOAST|", StringComparison.Ordinal))
            {
                var parts = s.Message.Split('|', 4);
                var body = parts.Length > 3 ? parts[3] : "";
                var ovr = parts.Length > 2 && !string.IsNullOrWhiteSpace(parts[2]) ? parts[2] : title;
                await JSRuntime.InvokeVoidAsync($"GLOBAL.toastrInterop.{method}", body, ovr);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync($"GLOBAL.toastrInterop.{method}", s.Message, title);
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("GLOBAL.toastrInterop.error", ex.Message, "Error");
        }
    }

    private void ShowOllamaHealthToast(AppHealthSnapshot? snap)
    {
        if (snap is null) return;                  // <-- add this
        var o = snap[HealthDomain.Ollama];         // indexer is safe if snap != null
        if (o.Level == HealthLevel.Unhealthy)
        {
            _ = ShowToastAsync(new StatusMessage(
                o.Error ?? "Ollama error",
                StatusLevel.Error,
                "Ollama",
                "Health"));
        }
        else if (o.Level == HealthLevel.Healthy)
        {
            var url = o.Meta is not null && o.Meta.TryGetValue("ServerUrl", out var u) ? u : null;
            _ = ShowToastAsync(new StatusMessage(
                url is null ? "Connected to Ollama" : $"Connected to Ollama ({url})",
                StatusLevel.Success,
                "Ollama",
                "Health"));
        }
    }


    public void Dispose()
    {
        if (_healthHandler is not null)
            Health.Changed -= _healthHandler;

        State.OnStatusMessage -= HandleStatus;
        _ref?.Dispose();
        cts.Cancel();
        cts.Dispose();
    }
}
