@using System.Data.SqlClient
@using AssistantEngine.Factories
@using AssistantEngine.UI.Services.Implementation.Config
@using AssistantEngine.UI.Services.Implementation.Database
@using AssistantEngine.UI.Services.Models
@using Microsoft.Extensions.AI
@inherits LayoutComponentBase
@inject IAssistantConfigStore ConfigStore;
@inject ChatClientState clientState;
@inject IDatabaseRegistry DbRegistry
@if (showSidebar) //dont neccessarily need this here currently but is good for if we want to have hide here in future maybe
{
    <aside class="chat-options-sidebar">
        <h3>Assistant Options</h3>


        <section>
            <h4><i class="fi fi-br-box"></i><span class="header-text-1">Preset</span></h4>
            <dl>
                <dt>
                   
                    Name/Identifier
                </dt>
                <dd class="tokencount-op-inner">
                    <InputText @bind-Value="AssistantConfig.Id"
                                 class="form-control mot2"/>
                </dd>
                <div class="section-save-inner">
                    <button id="save-chat-options" class="btn btn-primary" @onclick="SaveChatOptions">
                        Save Model
                    </button>
                    <p class="text-muted small chat-none-1">
                        Changes take effect immediately. Click “Save Model” only to make them permanent for future sessions.
                    </p>
                </div>

            </dl>
        </section>
       <section class="model-server-section">
    <h4>
        <i class="fi fi-br-network"></i>
        <span class="header-text-1">Model Server</span>
    </h4>
    <dl>
        <dt>Provider</dt>
        <dd class="tokencount-op-inner">
            <InputSelect @bind-Value="AssistantConfig.ModelProvider" class="form-control mot2">
                <option value="Ollama">Ollama</option>
            </InputSelect>
        </dd>

        <dt>
            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
               title="Base URL of your ollama server. If you have installed locally it is likely: http://localhost:11434"></i>
            Server URL
        </dt>
        <dd class="tokencount-op-inner">
            <InputText @bind-Value="AssistantConfig.ModelProviderUrl"
                       class="form-control mot2"
                       placeholder="http://localhost:11434"
                       @onblur="EnsureProviderUrl" />
        </dd>
    </dl>
</section>

      
        <section class="model-config-section">
            <h4>
                <i class="fi fi-br-brain-lightning"></i>
                <span class="header-text-1">Model Configuration</span>
            </h4>
            <dl>
                @foreach (var model in AssistantConfig.ModelOptions)
                {
                    var item = model;  @* local copy to fix closure *@
                    <div @key="item.Key" class="model-config-block mb-4">
                        <dt class="model-label"
                            @onclick="() => ToggleModel(item.Key)"
                            style="cursor: pointer; display: flex; align-items: center;">
                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                               title='@(item.Key == "Embedding"
                                                                                      ? "It is not advisable to change this as it will require re-embedding vector store"
                                                                                      : "")'>
                    </i>
                    <span>@item.Label</span>
                    <i class="fi fi-br-angle-@(_expanded.Contains(item.Key) ? "up" : "down") ms-auto"></i>
                </dt>

                @if (_expanded.Contains(item.Key))
                        {
                            <dd class="tokencount-op-inner">
                           

                                <div class="chatoption-subblock mt-2 px-2">
                                    <div class="form-group mb-2">
                                        <label>
                                           
                                            Model Id
                                        </label>
                                        <ModelDropdown OnSelect="@(async selected =>
                                                                                                                             {
                                                           item.Options.ModelId = selected.Name;
                                                           await OnStateChange.InvokeAsync();
                                                       })"
                                                         SelectedModel="@item.Options.ModelId" />
                                    </div>

                                    <div class="form-group mb-2">
                                        <label>
                                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                                               title="Controls randomness: lower values make output more deterministic; higher values increase variability (0.0–1.0)"></i>
                                            Temperature
                                        </label>
                                        <div class="temp-op-inner">
                                            <input type="range"
                                                   @bind="item.Options.Temperature"
                                                   min="0" max="1" step="0.1"
                                                   class="form-range flex-grow-1 range-temp" />
                                            <span id="temp-option-num" class="ms-2">@item.Options.Temperature</span>
                                        </div>
                                    </div>

                                    <div class="form-group mb-2">
                                        <label>
                                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                                               title="Keep tokens whose cumulative probability mass ≤ this value (0.0–1.0)"></i>
                                            Top P
                                        </label>
                                        <InputNumber @bind-Value="item.Options.TopP"
                                                     class="form-control"
                                                     step="0.01"
                                                     placeholder="default" />
                                    </div>

                                    <div class="form-group mb-2">
                                        <label>
                                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                                               title="Keep only the highest-probability K tokens"></i>
                                            Top K
                                        </label>
                                        <InputNumber @bind-Value="item.Options.TopK"
                                                     class="form-control"
                                                     step="1"
                                                     placeholder="default" />
                                    </div>

                                    <div class="form-group mb-2">
                                        <label>
                                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                                               title="Maximum number of tokens the model can generate"></i>
                                            Max Output Tokens
                                        </label>
                                        <InputNumber @bind-Value="item.Options.MaxOutputTokens"
                                                     class="form-control"
                                                     placeholder="unlimited" />
                                    </div>

                                    <div class="form-group mb-2">
                                        <label>
                                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                                               title="Discourage new topics by penalizing new tokens once they appear"></i>
                                            Presence Penalty
                                        </label>
                                        <InputNumber @bind-Value="item.Options.PresencePenalty"
                                                     class="form-control"
                                                     step="0.1"
                                                     placeholder="0" />
                                    </div>

                                    <div class="form-group mb-2">
                                        <label>
                                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                                               title="Discourage repeated tokens by applying a penalty each time they appear"></i>
                                            Frequency Penalty
                                        </label>
                                        <InputNumber @bind-Value="item.Options.FrequencyPenalty"
                                                     class="form-control"
                                                     step="0.1"
                                                     placeholder="0" />
                                    </div>
                                </div>
                            </dd>
                        }
                    </div>
                }
            </dl>
        </section>


        <section>
            <h4><i class="fi fi-br-settings"></i><span class="header-text-1">Context</span></h4>
            <dl>
                <dt>
                    <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                       title="Controls randomness: lower values make output more deterministic; higher values increase variability (0.0–1.0)"></i>
                    System Prompt
                </dt>
                <dd class="d-flex align-items-center context-op-inner">
                        <InputTextArea @bind-Value="AssistantConfig.SystemPrompt"
                                   class="form-control mot2" />
                </dd>
               

            </dl>
        </section>

        <section id="ingestion-settings">
            <h4><i class="fi fi-br-folder-open"></i><span class="header-text-1">RAG / Data Ingestion</span></h4>
            <dl>
                @foreach (var folder in AssistantConfig.IngestionPaths)
                {
                    <div class="ingestion-folder">
                        <dt class="path-dt">Path: <button class="btn btn-sm btn-danger mt-2" @onclick="@(() => RemoveFolder(folder))"><i class="fi-br-cross"></i></button></dt>
                        <dd class="penalty1-op-inner">
                            <InputText @bind-Value="folder.Path" class="form-control" />
                        </dd>

                       
     

                        <dt class="ext-dt">File Extensions:</dt>
                        <dd class="penalty1-op-inner">
                            <input type="text"
                                   class="form-control"
                                   placeholder="All supported types"
                                   value="@GetExtensionsString(folder)"
                                   @onchange="@((ChangeEventArgs e) => SetExtensions(folder, e.Value?.ToString()))" />

                        </dd>
                        <div class="explore-sub-cont">
                            <dt class="explore-dt">Explore Subfolders:</dt>
                            <dd class="subexplorer">
                                <InputCheckbox @bind-Value="folder.ExploreSubFolders" class="form-check-input ms-1" />
                            </dd>
                        </div>
                        

                    </div>
                }

                <button class="btn btn-sm btn-outline-primary add-ingest-btn" @onclick="AddFolder">Add Ingestion Path</button>
                <button class="reingest-btn"
                        @onclick="@(() => ReingestDocuments())">
                    Reingest
                </button>
            </dl>
        </section>
         <section id="database-section-1">
            <h4><i class="fi fi-br-database"></i><span class="header-text-1">Database Access</span></h4>
             <dl>
                @foreach (var database in AssistantConfig.Databases)
                {
                    <div class="database-setting">
                        <dt class="name-dt">
                            Name:
                            <button class="btn btn-sm btn-danger mt-2" @onclick="@(() => RemoveDatabase(database))">
                                <i class="fi-br-cross"></i>
                            </button>
                        </dt>
                        <dd class="penalty1-op-inner">
                            <InputText @bind-Value="database.Id" class="form-control"
                                       @oninput="(_) => editedDatabases.Add(database.Id)" />
                        </dd>

                        <dt>
                            <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                               title="Database specific considerations injected when requesting information."></i>
                            Database Considerations
                        </dt>
                        <dd class="tokencount-op-inner">
                            <InputTextArea @bind-Value="database.DatabaseConsiderations" class="form-control mot2"
                                           @oninput="(_) => editedDatabases.Add(database.Id)" />
                        </dd>

                        <dt>Connection String</dt>
                        <dd class="tokencount-op-inner">
                            <InputTextArea @bind-Value="database.ConnectionString" class="form-control mot2"
                                           @oninput="(_) => editedDatabases.Add(database.Id)" />
                        </dd>

                        <dt class="ext-dt">Dialect:</dt>
                        <dd class="penalty1-op-inner">
                            <InputText @bind-Value="database.Dialect" class="form-control"
                                       @oninput="(_) => editedDatabases.Add(database.Id)" />
                        </dd>

                        <div class="describe-db">
                            <dt class="ext-dt">
                                <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                                   title="Describe database prior to ingestion"></i> Describe Database:
                            </dt>
                            <dd class="subexplorer">
                                <InputCheckbox @bind-Value="database.DescribeDatabaseWithModel" class="form-check-input ms-1"
                                               @onchange="(_) => editedDatabases.Add(database.Id)" />
                            </dd>
                        </div>

                        <button class="save-database-btn"
                                @onclick="@(() => SaveDatabase(database))"
                                style="display:@(editedDatabases.Contains(database.Id) ? "inline-block" : "none")">
                            Save
                        </button>
                        
                    </div>
                }

                <button class="btn btn-sm btn-outline-primary add-db-btn" @onclick="AddDatabase">Add Database</button>
                <button class="reingest-btn"
                        @onclick="@(() => ReingestDatabases())">
                    Reingest Database
                </button>
            </dl>
        </section>

             <section>
            <h4><i class="fi fi-br-lock"></i><span class="header-text-1">Non-Configurable</span></h4>
            <dl class="text-secondary small">
               
              
                <dt>
                    <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                       title="Tools built in and configured with this model"></i>
                    Tools
                </dt>
                <dd id="tools-options-cont">
                    @foreach (var tool in AssistantConfig.AssistantModel.Tools ?? Enumerable.Empty<AITool>())
                    {
                        <div class="badge badge-1">@tool.Name</div>
                    }
                </dd>
                @*<dt>
                    <i class="fi fi-br-info me-1 fs-6 align-text-bottom text-muted"
                       title="Sequences at which the model will stop generating"></i>
                    Stop Sequences
                </dt>
                <dd>@string.Join(", ", AssistantConfig.AssistantModel.StopSequences ?? Array.Empty<string>())</dd>*@

               
            </dl>
        </section>
        <section id="wipe">
            <button class="wipe-btn"
                    @onclick="@(() => WipeVectorStores())">
                Delete Vector Stores
            </button>
        </section>
    </aside>
}

@code {
    //so to implement saving here. we do the seperate structure
    [Parameter]
    public AssistantConfig AssistantConfig { get; set; } = new();

    private Dictionary<DatabaseConfiguration, DatabaseConfiguration> lastSaved = new();
    [Parameter]
    public EventCallback OnStateChange { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }
    private HashSet<string> editedDatabases = new();
    //private ChatOptions ChatOptions => ModelConfig.ChatOptions;
    private bool showSidebar = true;
    private HashSet<string> _expanded = new();
    private void ToggleSidebar()
    {
        showSidebar = !showSidebar;
    }
    private string? _originalId;

    protected override void OnInitialized()
    {
        if (AssistantConfig?.Databases != null)
        {
            foreach (var db in AssistantConfig.Databases)
            {
                if (!lastSaved.ContainsKey(db))
                {
                    lastSaved[db] = db.Clone();
                }
            }
        }
    }// initialize original id once the parameter arrives
    protected override void OnParametersSet()
    {
        if (string.IsNullOrWhiteSpace(_originalId) && !string.IsNullOrWhiteSpace(AssistantConfig?.Id))
            _originalId = AssistantConfig.Id;

        // existing init you already have...
        if (AssistantConfig?.Databases != null)
        {
            foreach (var db in AssistantConfig.Databases)
                if (!lastSaved.ContainsKey(db)) lastSaved[db] = db.Clone();
        }
    }


    bool isSaving;
    private async Task SaveChatOptions()
    {
        try
        {
            AssistantConfig.Name = AssistantConfig.Id;  
            isSaving = true;
            await ConfigStore.UpdateAsync(_originalId!, AssistantConfig);
            _originalId = AssistantConfig.Id;
            clientState.StatusMessage("Model saved successfully");
            await OnStateChange.InvokeAsync(); 
        }catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
            Console.WriteLine(ex.StackTrace);
        }
        finally
        {
            isSaving = false;
        }
    }private void EnsureProviderUrl()
{
    if (string.IsNullOrWhiteSpace(AssistantConfig.ModelProviderUrl))
        AssistantConfig.ModelProviderUrl = "http://localhost:11434";
}
    private void AddFolder()
    {
        AssistantConfig.IngestionPaths ??= new();
        AssistantConfig.IngestionPaths.Add(new IngestionSourceFolder());
    }
    private bool IsValidConnectionString(string connectionString)
    {
        try
        {
            using var conn = new SqlConnection(connectionString);
            conn.Open();
            return true;
        }
        catch
        {
            return false;
        }
    }
    private void ReingestDatabase()
    {

    }
    private async Task WipeVectorStores()
    {
        await clientState.RecreateAndReingestAsync();
    }
    private async Task ReingestDatabases()
    {
        await clientState.ReingestDatabases();
    }

    private async Task ReingestDocuments()
    {
        clientState.StatusMessage($"Starting Reingestion. Save model file to persist knowledge upon reload.");
        await clientState.ReingestDocuments();
    }
    private void SaveDatabase(DatabaseConfiguration dbConfig)
    {
        if (string.IsNullOrWhiteSpace(dbConfig.ConnectionString))
        {
            clientState.StatusMessage($"Skipping save: {dbConfig.Id} has no connection string.");
            return;
        }

        if (!IsValidConnectionString(dbConfig.ConnectionString))
        {
            clientState.StatusMessage($"Invalid connection string for {dbConfig.Id}");
            return;
        }
        editedDatabases.Remove(dbConfig.Id);
        // detect rename: lookup by the live object key
        if (lastSaved.TryGetValue(dbConfig, out var oldSnapshot) &&
            oldSnapshot.Id != dbConfig.Id)
        {
            DbRegistry.Remove(oldSnapshot.Id);
            clientState.StatusMessage($"Database renamed from {oldSnapshot.Id} → {dbConfig.Id}");
        }

        bool exists = DbRegistry.Get(dbConfig.Id) is not null;

        lastSaved[dbConfig] = dbConfig.Clone();
        DbRegistry.Register(dbConfig);

        clientState.StatusMessage(
            exists
                ? $"Database {dbConfig.Id} updated successfully."
                : $"Database {dbConfig.Id} registered successfully."
        );
    }


    void AddDatabase()
    {
        var config = new DatabaseConfiguration
        {
            Id = "New Database",
            DatabaseConsiderations = "When querying the database, take into account that..."
        };
        AssistantConfig.Databases.Add(config);
    }

    void RemoveDatabase(DatabaseConfiguration db)
    {
        // remove from model
        AssistantConfig.Databases.Remove(db);

        // remove from registry (by current Id if still valid)
        if (!string.IsNullOrWhiteSpace(db.Id))
        {
            DbRegistry.Remove(db.Id);
        }

        // remove from lastSaved snapshot by object reference
        if (lastSaved.TryGetValue(db, out var snapshot))
        {
            // also remove the old Id if it differs
            if (!string.IsNullOrWhiteSpace(snapshot.Id) && snapshot.Id != db.Id)
            {
                DbRegistry.Remove(snapshot.Id);
            }

            lastSaved.Remove(db);
        }

        clientState.StatusMessage($"Database {db.Id} removed.");
    }
    private void RemoveFolder(IngestionSourceFolder folder)
    {
        AssistantConfig.IngestionPaths.Remove(folder);
    }
   


    private string GetExtensionsString(IngestionSourceFolder folder)
    {
        return folder.FileExtensions == null ? "" : string.Join(",", folder.FileExtensions);
    }
    private void ToggleModel(string key)
    {
        if (!_expanded.Add(key))
            _expanded.Remove(key);
    }
    private void SetExtensions(IngestionSourceFolder folder, string value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            folder.FileExtensions = null;
        }
        else
        {
            folder.FileExtensions = value.Split(',')
                .Select(e => e.Trim())
                .Where(e => !string.IsNullOrWhiteSpace(e))
                .ToList();
        }
    }

}
