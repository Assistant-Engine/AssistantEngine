@using AssistantEngine.Factories
@using AssistantEngine.UI.Services
@using AssistantEngine.UI.Services.Implementation.Models.Chat
@using AssistantEngine.UI.Services.Models.Chat
@using AssistantEngine.UI.Pages.Chat.AssistantSettings

@inject IJSRuntime JSRuntime
@inject ChatClientState ClientState
@inject IChatRepository ChatRepository
@implements IDisposable

@if (showPageSpinner)
{
    <PageSpinner1 />
}

@if (showChatMessageSidebar)
{
    <ChatSidebar OnNewChat="@ResetConversationAsync"
                 CurrentSession="@ClientState.Session"
                 CurrentSessionChanged="OnSessionChanged"
                 OpenSettingsModalRequested="OpenSettingsModal" />
}

<OllamaImportModal @ref="_importModal" />
<GlobalSettingsModal @ref="_settingsModal" />

<div id="chat-container-outer">
    <div class="chat-container-inner">

        <ChatHeader @ref="header"
                    OnToggleEvaluations="ToggleEvaluations"
                    OpenModalRequested="OpenImportModal"
                    OnStateChange="@SwitchModel"
                    OnNewChat="@ResetConversationAsync"
                    OnStateSelected="SwitchModel2"
                    OnToggleChatOptionsSidebar="ToggleChatOptionsSidebar"
                    OnToggleChatMessageSidebar="ToggleChatMessageSidebar"
                    IsSidebarVisible="@showChatOptionsSidebar" />

        @if (!isIngesting)
        {
            <ChatMessageList Messages="@ClientState.Messages"
                             InProgressMessage="@ClientState.InProgress"
                             IsLoading="@ClientState.IsLoading"
                             IsStreaming="@ClientState.IsStreaming"
                             ChatResponse="@ClientState.ChatResponse"
                             OnEditSubmit="@OnUserEditSubmit">
                <NoMessagesContent>
                    <img src="_content/AssistantEngine.UI/img/logo-watermark-2.svg" id="inner-logo-main" />
                </NoMessagesContent>
            </ChatMessageList>
        }
        else
        {
            <LoadingSpinner Visible="@isIngesting" Message="Ingesting Data..." />
        }

        <div id="chat-container" class="chat-container">
            <ChatSuggestions OnSelected="@AddUserMessageAsync" @ref="@chatSuggestions" />
            <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput" />
        </div>
    </div>

    @if (showChatOptionsSidebar)
    {
        <AssistantSettingsSidebar OnStateChange="@SwitchModel"
                                  AssistantConfig="@ClientState.Config"
                                  class="order-last" />
    }
</div>

@code {
    private ChatHeader? header;
    private OllamaImportModal? _importModal;
    private GlobalSettingsModal? _settingsModal;
    private ChatInput? chatInput;
    private ChatSuggestions? chatSuggestions;

    // UI state
    private bool showPageSpinner = false;
    private bool showChatOptionsSidebar = true;
    private bool showChatMessageSidebar = true;
    private bool isIngesting => !ClientState.IngestionFinished;
    private Action<bool, string?>? _loaderHandler;

    private void HandleStateChanged() => _ = InvokeAsync(StateHasChanged);

    protected override void OnInitialized()
    {
        _loaderHandler = (v, m) => _ = InvokeAsync(StateHasChanged);
        ClientState.OnLoaderMessage += _loaderHandler;

        ClientState.OnStateChanged -= HandleStateChanged; // avoid dupes
        ClientState.OnStateChanged += HandleStateChanged;
    }

    public void Dispose()
    {
        if (_loaderHandler is not null)
            ClientState.OnLoaderMessage -= _loaderHandler;

        ClientState.OnStateChanged -= HandleStateChanged;
    }

    private void ToggleChatOptionsSidebar() => showChatOptionsSidebar = !showChatOptionsSidebar;
    private void ToggleChatMessageSidebar() => showChatMessageSidebar = !showChatMessageSidebar;

    private void ToggleEvaluations() { /* hook up when ready */ }

    private async Task SwitchModel()
    {
        await ChatRepository.SaveAsync(ClientState.Session);
        ClientState.RefreshTools();
        await InvokeAsync(StateHasChanged);
    }

    private Task SwitchModel2() => Task.CompletedTask;

    private void OpenSettingsModal() => _settingsModal?.Open();
    private void OpenImportModal() => _importModal?.OpenDownloadModal();

    private async Task OnSessionChanged(ChatSession session)
    {
        await ClientState.LoadSessionAsync(session);
        await InvokeAsync(StateHasChanged);
    }

    // Sending/editing messages
    private async Task AddUserMessageAsync(ChatMessage userMessage)
    {
        _ = chatInput!.FocusAsync();
        await ClientState.EnqueueAndRunAsync(userMessage);
    }

    private async Task OnUserEditSubmit((ChatMessage message, string newText) edit)
    {
        await ClientState.EditAndRegenerateAsync(edit.message.MessageId!, edit.newText);
    }

    private async Task ResetConversationAsync()
    {
        await ClientState.ResetConversationAsync();
        await chatInput!.FocusAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!ClientState.IsStreaming)          // skip while streaming
            await JSRuntime.InvokeVoidAsync("GLOBAL.HighlightAllPrism");
    }
}
